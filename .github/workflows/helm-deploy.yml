name: Helm Deploy

on:
  workflow_run:
    workflows: ["Deploy Docker Image"]
    types:
      - completed

jobs:
  helm-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate with Google Cloud
      run: |
        echo "${{ secrets.GCP_CREDENTIALS_BASE64 }}" | base64 -d > gcp-key.json
        gcloud auth activate-service-account --key-file=gcp-key.json
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        gcloud container clusters get-credentials devops-cluster --region us-central1 --project ${{ secrets.GCP_PROJECT_ID }}

    - name: Install Google Cloud SDK
      run: |
        echo "deb https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install google-cloud-sdk

    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: Deploy with Helm
      run: |
        helm upgrade --install flask-app ./mychart/flask-chart
