name: Deploy Docker Image

on:
  workflow_run:
    workflows: ["Build Docker Image and Push to Docker Hub"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Pull the Docker image
    - name: Pull Docker image
      run: |
        docker pull romliani/devops-project-flask:latest

    # 4. Run Docker container for testing
    - name: Run Docker container for testing
      run: |
        docker run -d -p 5000:5000 --name flask_test romliani/devops-project-flask:latest
        sleep 20 # Wait for the container to initialize

    # 5. Test if Flask app is running
    - name: Test if Flask app is running
      run: |
        for i in {1..10}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Flask app is up and running!"
            break
          else
            echo "Waiting for Flask app to start... (Attempt $i)"
            sleep 5
          fi
        done

    # 6. View Docker container logs for debugging
    - name: View Docker container logs
      run: docker logs flask_test

    # 7. Configure GKE authentication
    - name: Set up GKE Authentication
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    # 8. Install gke-gcloud-auth-plugin
    - name: Install gke-gcloud-auth-plugin
      run: |
        curl -sSL https://sdk.cloud.google.com | bash
        source $HOME/google-cloud-sdk/path.bash.inc
        gcloud components install gke-gcloud-auth-plugin

    # 9. Set up kubectl for GKE
    - name: Set up GKE kubectl
      run: |
        gcloud container clusters get-credentials devops-cluster --zone us-east1 --project ${{ secrets.GCP_PROJECT_ID }}

    # 10. Deploy to GKE
    - name: Deploy to GKE
      run: |
        kubectl set image deployment/flask-app flask-app=romliani/devops-project-flask:latest --record

    # 11. Wait for deployment to complete
    - name: Wait for deployment to complete
      run: |
        kubectl rollout status deployment/flask-app
